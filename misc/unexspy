local function missing(t, f, fallback)
	if type(f) == t then return f end
	return fallback
end

cloneref = missing("function", cloneref, function(...) return ... end)

local Players = cloneref(game:GetService("Players"))
local UserInputService = cloneref(game:GetService("UserInputService"))

local localPlayer = Players.LocalPlayer
local character = localPlayer.Character or localPlayer.CharacterAdded:Wait()

local CoreGui
do
	local success
	success, CoreGui = pcall(function() return game:GetService("CoreGui") end)
	if not success or not CoreGui then
		CoreGui = nil
	end
end

local guiParent
if CoreGui then
	guiParent = CoreGui
else
	guiParent = localPlayer:WaitForChild("PlayerGui")
end

local function randomString(len)
	len = len or math.random(10,20)
	local charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"
	local res = {}
	for i=1,len do
		res[i] = charset:sub(math.random(#charset), math.random(#charset))
	end
	return table.concat(res)
end

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = randomString()
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = guiParent

local Main = Instance.new("Frame")
Main.Size = UDim2.new(0, 530, 0, 285)
Main.Position = UDim2.new(0.5, -265, 0.5, -142)
Main.BackgroundColor3 = Color3.fromRGB(18,18,18)
Main.BorderSizePixel = 0
Main.Parent = ScreenGui

local dragging, dragInput, dragStart, startPos
Main.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
		dragStart = input.Position
		startPos = Main.Position
		input:GetPropertyChangedSignal("UserInputState"):Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
			end
		end)
	end
end)
Main.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseMovement then
		dragInput = input
	end
end)
UserInputService.InputChanged:Connect(function(input)
	if dragging and input == dragInput then
		local delta = input.Position - dragStart
		Main.Position = startPos + UDim2.fromOffset(delta.X, delta.Y)
	end
end)

local function addStroke(inst)
	local stroke = Instance.new("UIStroke")
	stroke.Color = Color3.fromRGB(60,60,60)
	stroke.Parent = inst
end

addStroke(Main)

local CodePreview = Instance.new("Frame")
CodePreview.Size = UDim2.new(0, 334, 0, 170)
CodePreview.Position = UDim2.new(0.48, -159, 1.62, -455)
CodePreview.BackgroundColor3 = Color3.fromRGB(18,18,18)
CodePreview.BorderSizePixel = 0
CodePreview.Parent = Main
addStroke(CodePreview)

local Preview = Instance.new("TextBox")
Preview.Size = UDim2.new(0, 310, 0, 147)
Preview.Position = UDim2.new(0.036, 0, 0.065, 0)
Preview.BackgroundTransparency = 1
Preview.TextColor3 = Color3.fromRGB(178,178,178)
Preview.TextSize = 14
Preview.TextWrapped = true
Preview.TextXAlignment = Enum.TextXAlignment.Left
Preview.TextYAlignment = Enum.TextYAlignment.Top
Preview.ClearTextOnFocus = false
Preview.Text = "-- No code"
Preview.BorderSizePixel = 0
Preview.Parent = CodePreview

local Title = Instance.new("TextLabel")
Title.Text = "unexSpy"
Title.Size = UDim2.new(0, 135, 0, 40)
Title.Position = UDim2.new(0.16, -67, 0.89, -20)
Title.BackgroundTransparency = 1
Title.TextColor3 = Color3.fromRGB(178,178,178)
Title.TextSize = 16
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.Parent = Main

addStroke(Main)

local RemoteList = Instance.new("ScrollingFrame")
RemoteList.Size = UDim2.new(0, 176, 0, 235)
RemoteList.Position = UDim2.new(0.5, -88, 0.05, 0)
RemoteList.BackgroundTransparency = 1
RemoteList.BorderSizePixel = 0
RemoteList.Active = true
RemoteList.ScrollBarImageTransparency = 1
RemoteList.Parent = Main

local layout = Instance.new("UIListLayout")
layout.SortOrder = Enum.SortOrder.LayoutOrder
layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
layout.VerticalAlignment = Enum.VerticalAlignment.Top
layout.Padding = UDim.new(0, 6)
layout.Parent = RemoteList

RemoteList.AutomaticCanvasSize = Enum.AutomaticSize.Y

local blockedRemotes = {}
local logs = {}
getgenv().UnexSpyLogs = logs

local mt, old = getrawmetatable(game)
setreadonly(mt, false)
old = mt.__namecall

local function path(instance)
	local seg = {}
	while instance and instance ~= game do
		local name = instance.Name
		table.insert(seg, 1, name:match("^[%a_][%w_]*$") and "."..name or string.format("[%q]", name))
		instance = instance.Parent
	end
	local s = seg[1] or ""
	return s:match("^%.") and ("game:GetService(%q)%s"):format(s:sub(2), table.concat(seg, "", 2)) or "game"..table.concat(seg)
end

local function serialize(value)
	local t = typeof(value)
	if t == "string" then return ("%q"):format(value)
	elseif t == "number" or t == "boolean" then return tostring(value)
	elseif t == "Instance" then return path(value)
	elseif t == "table" then
		local out = {}
		for k,v in pairs(value) do
			out[#out+1] = "["..serialize(k).."]="..serialize(v)
		end
		return "{"..table.concat(out,",").."}"
	end
	return "nil --[["..t.."]]"
end

local RemoteTemplate = Instance.new("Frame")
RemoteTemplate.Size = UDim2.new(1, -12, 0, 31)
RemoteTemplate.BackgroundColor3 = Color3.fromRGB(18,18,18)
RemoteTemplate.BorderSizePixel = 0
addStroke(RemoteTemplate)
RemoteTemplate.Visible = false
RemoteTemplate.Parent = RemoteList

local RemoteButtonTemplate = Instance.new("TextButton")
RemoteButtonTemplate.BackgroundTransparency = 1
RemoteButtonTemplate.Size = UDim2.new(1, -10, 1, 0)
RemoteButtonTemplate.TextXAlignment = Enum.TextXAlignment.Left
RemoteButtonTemplate.TextWrapped = true
RemoteButtonTemplate.Font = Enum.Font.Gotham
RemoteButtonTemplate.TextSize = 14
RemoteButtonTemplate.TextColor3 = Color3.fromRGB(178,178,178)
RemoteButtonTemplate.BorderSizePixel = 0
RemoteButtonTemplate.Parent = RemoteTemplate

local function createLog(remote, method, args)
	if blockedRemotes[remote.Name] then return end

	local code = ("-- unexSpy - by Hashed\nlocal args = %s\n%s:%s(unpack(args))"):format(serialize(args), path(remote), method)
	local clone = RemoteTemplate:Clone()
	clone.Visible = true
	clone.Parent = RemoteList

	local btn = clone:FindFirstChildOfClass("TextButton")
	btn.Text = remote.Name
	btn.MouseButton1Click:Connect(function()
		Preview.Text = code
	end)
end

mt.__namecall = newcclosure(function(self, ...)
	local method = getnamecallmethod()
	if not checkcaller() and (method == "FireServer" or method == "InvokeServer") then
		if blockedRemotes[self.Name] then return end
		table.insert(logs, {remote = self, method = method, args = {...}})
	end
	return old(self, ...)
end)
setreadonly(mt, true)

task.spawn(function()
	while true do
		for _, log in ipairs(logs) do
			createLog(log.remote, log.method, log.args)
		end
		table.clear(logs)
		task.wait(0.2)
	end
end)

local function makeButton(text, position)
	local frame = Instance.new("Frame")
	frame.Size = UDim2.new(0, 105, 0, 31)
	frame.Position = position
	frame.BackgroundColor3 = Color3.fromRGB(18,18,18)
	frame.BorderSizePixel = 0
	frame.Parent = Main
	addStroke(frame)

	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(0, 95, 0, 31)
	btn.Position = UDim2.new(0.05, 0, 0, 0)
	btn.BackgroundTransparency = 1
	btn.TextColor3 = Color3.fromRGB(178,178,178)
	btn.TextSize = 14
	btn.TextWrapped = true
	btn.TextXAlignment = Enum.TextXAlignment.Left
	btn.BorderSizePixel = 0
	btn.Font = Enum.Font.Gotham
	btn.Text = text
	btn.Parent = frame
	return btn
end

local CCButton = makeButton("Copy Code", UDim2.new(0.48, -159, 2.27, -455))
local BLKButton = makeButton("Block", UDim2.new(0.48, -159, 2.41, -455))
local SSButton = makeButton("SimpleSpy", UDim2.new(0.79, -159, 2.41, -455))
local CRButton = makeButton("Copy Remote", UDim2.new(0.79, -159, 2.27, -455))
local CLRBLKSButton = makeButton("Clr Blocks", UDim2.new(1.12, -159, 2.41, -455))
local RCButton = makeButton("Run Code", UDim2.new(1.12, -159, 2.27, -455))

CCButton.MouseButton1Click:Connect(function()
	if setclipboard then
		setclipboard(Preview.Text)
	end
end)

RCButton.MouseButton1Click:Connect(function()
	local func, err = loadstring(Preview.Text)
	if func then
		func()
	else
		warn("Code execution failed:", err)
	end
end)

CRButton.MouseButton1Click:Connect(function()
	local remoteName = Preview.Text:match("game%.([%w%._]+)")
	if remoteName and setclipboard then
		setclipboard("game." .. remoteName)
	end
end)

BLKButton.MouseButton1Click:Connect(function()
	local remoteName = Preview.Text:match("([%w_]+)")
	if remoteName then
		blockedRemotes[remoteName] = true
	end
end)

CLRBLKSButton.MouseButton1Click:Connect(function()
	blockedRemotes = {}
end)
